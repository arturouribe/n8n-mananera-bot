{
  "name": "Resumen MaÃ±anera del Pueblo - v5 JavaScript",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 15 * * 1-5"
            }
          ]
        }
      },
      "id": "schedule_trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        240,
        300
      ],
      "notes": "â° Ejecuta L-V a las 9:00 AM hora MÃ©xico (15:00 UTC)"
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        240,
        480
      ],
      "notes": "ðŸ”§ Para bÃºsquedas HISTÃ“RICAS con fecha especÃ­fica"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fecha_param",
              "name": "fecha_parametro",
              "value": "2026-02-03",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "set_date",
      "name": "Set Date Parameter",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        420,
        480
      ],
      "notes": "âš ï¸ CAMBIAR FECHA AQUÃ para bÃºsqueda histÃ³rica: yyyy-MM-dd"
    },
    {
      "parameters": {
        "jsCode": "// ======================================================\n// LÃ“GICA DIFERENCIADA: MANUAL vs AUTOMÃTICO\n// ======================================================\n\nconst inputData = $input.first().json;\nlet fechaBusqueda;\nlet isManual = false;\nlet searchStart, searchEnd;\n\n// Determinar si es ejecuciÃ³n manual o automÃ¡tica\nif (inputData.fecha_parametro) {\n  // ============================================\n  // MODO MANUAL (HISTÃ“RICO)\n  // ============================================\n  isManual = true;\n  fechaBusqueda = inputData.fecha_parametro;\n  \n  // Para bÃºsqueda histÃ³rica: TODO EL DÃA (00:00 a 23:59 UTC)\n  searchStart = `${fechaBusqueda}T00:00:00Z`;\n  searchEnd = `${fechaBusqueda}T23:59:59Z`;\n  \n  console.log('ðŸ” MODO MANUAL - BÃºsqueda histÃ³rica');\n  console.log(`   Fecha: ${fechaBusqueda}`);\n  console.log(`   Rango: TODO EL DÃA (00:00-23:59 UTC)`);\n  \n} else {\n  // ============================================\n  // MODO AUTOMÃTICO (SCHEDULE)\n  // ============================================\n  isManual = false;\n  \n  // Usar fecha actual de MÃ©xico\n  const now = new Date();\n  const year = now.getFullYear();\n  const month = String(now.getMonth() + 1).padStart(2, '0');\n  const day = String(now.getDate()).padStart(2, '0');\n  fechaBusqueda = `${year}-${month}-${day}`;\n  \n  // Para ejecuciÃ³n automÃ¡tica a las 9:00 AM MÃ©xico:\n  // Buscar videos publicados desde las 5:00 AM hasta las 9:00 AM MÃ©xico\n  // MÃ©xico (UTC-6): \n  //   5:00 AM MÃ©xico = 11:00 UTC\n  //   9:00 AM MÃ©xico = 15:00 UTC\n  searchStart = `${fechaBusqueda}T11:00:00Z`;  // 5 AM MÃ©xico\n  searchEnd = `${fechaBusqueda}T15:00:00Z`;    // 9 AM MÃ©xico\n  \n  console.log('â° MODO AUTOMÃTICO - Esperando fin de transmisiÃ³n');\n  console.log(`   Fecha: ${fechaBusqueda}`);\n  console.log(`   Rango: 5:00-9:00 AM MÃ©xico (11:00-15:00 UTC)`);\n  console.log(`   La maÃ±anera termina ~9:00 AM, buscamos video ya publicado`);\n}\n\nreturn [{\n  json: {\n    fecha_busqueda: fechaBusqueda,\n    channel_id: 'UCvzHrtf9by1-UY67SfZse8w',\n    search_start: searchStart,\n    search_end: searchEnd,\n    is_manual: isManual,\n    modo: isManual ? 'HISTÃ“RICO' : 'AUTOMÃTICO'\n  }\n}];"
      },
      "id": "merge_config",
      "name": "Merge Configuration",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        380
      ],
      "notes": "âœ… LÃ“GICA CORREGIDA: Manual=TODO EL DÃA, Auto=5-9AM"
    },
    {
      "parameters": {
        "url": "=https://www.googleapis.com/youtube/v3/search?part=snippet&channelId={{ $json.channel_id }}&publishedAfter={{ $json.search_start }}&publishedBefore={{ $json.search_end }}&maxResults=10&order=date&type=video&q=maÃ±anera+conferencia&key={{ $env.YOUTUBE_API_KEY }}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "get_youtube",
      "name": "Get YouTube Videos",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        800,
        380
      ],
      "notes": "ðŸ“¹ Busca videos en el rango de tiempo especificado"
    },
    {
      "parameters": {
        "jsCode": "// ======================================================\n// FILTRAR Y SELECCIONAR VIDEO DE LA MAÃ‘ANERA\n// ======================================================\n\nconst items = $input.all();\nconst response = items[0].json;\nconst config = $('Merge Configuration').first().json;\n\nconsole.log('\\n========================================');\nconsole.log(`MODO: ${config.modo}`);\nconsole.log(`FECHA: ${config.fecha_busqueda}`);\nconsole.log(`RANGO: ${config.search_start} â†’ ${config.search_end}`);\nconsole.log('========================================\\n');\n\n// Verificar si hay error en la respuesta\nif (response.error) {\n  console.error('âŒ Error de YouTube API:', response.error.message);\n  return [{ \n    json: { \n      video_id: null, \n      error: true, \n      message: `Error de YouTube API: ${response.error.message}`,\n      debug_response: response\n    } \n  }];\n}\n\n// Verificar si hay items\nif (!response.items || response.items.length === 0) {\n  console.warn('âš ï¸ No se encontraron videos en el rango especificado');\n  return [{ \n    json: { \n      video_id: null, \n      error: true, \n      message: `No se encontraron videos en el rango de tiempo (${config.modo})`,\n      debug_info: {\n        modo: config.modo,\n        fecha: config.fecha_busqueda,\n        search_start: config.search_start,\n        search_end: config.search_end\n      }\n    } \n  }];\n}\n\nconst videos = response.items;\nconsole.log(`âœ“ Encontrados ${videos.length} videos`);\n\n// Mostrar todos los videos encontrados para debug\nvideos.forEach((v, i) => {\n  console.log(`  ${i+1}. ${v.snippet.title}`);\n  console.log(`     Publicado: ${v.snippet.publishedAt}`);\n});\n\n// Palabras clave para identificar la maÃ±anera\nconst keywords = [\n  'maÃ±anera', \n  'conferencia', \n  'presidente', \n  'presidenta', \n  'matutina', \n  'gobierno',\n  'palacio nacional'\n];\n\n// Buscar video que contenga palabras clave\nlet mananera = videos.find(v => {\n  const title = (v.snippet.title || '').toLowerCase();\n  const description = (v.snippet.description || '').toLowerCase();\n  const hasKeyword = keywords.some(keyword => \n    title.includes(keyword) || description.includes(keyword)\n  );\n  \n  if (hasKeyword) {\n    console.log(`\\nâœ“ VIDEO IDENTIFICADO CON KEYWORDS:`);\n    console.log(`  TÃ­tulo: ${v.snippet.title}`);\n    console.log(`  Publicado: ${v.snippet.publishedAt}`);\n  }\n  \n  return hasKeyword;\n});\n\n// Si no encuentra con keywords, tomar el video mÃ¡s largo\n// (la maÃ±anera suele ser el video mÃ¡s largo del dÃ­a)\nif (!mananera && videos.length > 0) {\n  console.log('\\nâš ï¸ No se encontrÃ³ con keywords');\n  console.log('   Tomando primer video (probablemente la maÃ±anera)');\n  mananera = videos[0];\n}\n\n// VerificaciÃ³n final\nif (!mananera) {\n  console.error('âŒ No se pudo identificar la maÃ±anera');\n  return [{ \n    json: { \n      video_id: null, \n      error: true, \n      message: 'No se pudo identificar la maÃ±anera entre los videos encontrados',\n      videos_found: videos.length\n    } \n  }];\n}\n\n// Verificar que tenga videoId\nif (!mananera.id || !mananera.id.videoId) {\n  console.error('âŒ Video sin videoId vÃ¡lido');\n  return [{ \n    json: { \n      video_id: null, \n      error: true, \n      message: 'El video encontrado no tiene videoId vÃ¡lido',\n      debug_video: mananera\n    } \n  }];\n}\n\nconst videoId = mananera.id.videoId;\nconst videoUrl = `https://www.youtube.com/watch?v=${videoId}`;\n\nconsole.log('\\nâœ… VIDEO SELECCIONADO:');\nconsole.log(`   TÃ­tulo: ${mananera.snippet.title}`);\nconsole.log(`   Video ID: ${videoId}`);\nconsole.log(`   URL: ${videoUrl}`);\nconsole.log(`   Publicado: ${mananera.snippet.publishedAt}`);\nconsole.log('========================================\\n');\n\nreturn [{\n  json: {\n    video_id: videoId,\n    title: mananera.snippet.title,\n    description: mananera.snippet.description || '',\n    published_at: mananera.snippet.publishedAt,\n    thumbnail: mananera.snippet.thumbnails?.high?.url || \n               mananera.snippet.thumbnails?.default?.url || '',\n    channel_title: mananera.snippet.channelTitle,\n    video_url: videoUrl,\n    modo_busqueda: config.modo,\n    error: false\n  }\n}];"
      },
      "id": "filter_video",
      "name": "Filter MaÃ±anera Video",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1000,
        380
      ],
      "notes": "ðŸ” Identifica el video de la maÃ±anera con logs detallados"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition_1",
              "leftValue": "={{ $json.video_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "condition_2",
              "leftValue": "={{ $json.error }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check_video",
      "name": "Check Video Exists",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1200,
        380
      ]
    },
    {
      "parameters": {
        "jsCode": "const transcriptionData = $input.first().json;\nconst videoData = $('Save Transcript ID').first().json;\n\nconst fullText = transcriptionData.text || '';\nconst utterances = transcriptionData.utterances || [];\n\nlet formattedTranscription = '=== TRANSCRIPCIÃ“N MAÃ‘ANERA DEL PUEBLO ===\\n\\n';\n\nif (utterances.length > 0) {\n  console.log(`\\nâœ… TRANSCRIPCIÃ“N COMPLETADA:`);\n  console.log(`   Speakers identificados: ${utterances.length} utterances`);\n  utterances.forEach((utterance, index) => {\n    const speaker = utterance.speaker || 'Speaker';\n    const text = utterance.text || '';\n    formattedTranscription += `[${speaker}]: ${text}\\n\\n`;\n  });\n} else {\n  console.log(`\\nâœ… TRANSCRIPCIÃ“N COMPLETADA (sin speakers):`);\n  formattedTranscription += fullText;\n}\n\nconst confidence = (transcriptionData.confidence * 100).toFixed(1);\nconst words = transcriptionData.words?.length || 0;\nconst duration = Math.floor((transcriptionData.audio_duration || 0) / 60);\n\nconsole.log(`   Caracteres: ${fullText.length}`);\nconsole.log(`   Palabras: ${words}`);\nconsole.log(`   DuraciÃ³n: ${duration} minutos`);\nconsole.log(`   Confianza: ${confidence}%`);\n\nreturn [{\n  json: {\n    ...videoData,\n    transcription: formattedTranscription,\n    transcription_raw: fullText,\n    transcription_confidence: transcriptionData.confidence || 0,\n    transcription_words: words,\n    transcription_duration: transcriptionData.audio_duration || 0,\n    utterances_count: utterances.length,\n    processing_completed: true\n  }\n}];"
      },
      "id": "process_transcription",
      "name": "Process Transcription",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2400,
        180
      ],
      "notes": "ðŸ“„ Procesa y formatea transcripciÃ³n"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpQueryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "={{ $env.GEMINI_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": \"Eres un analista polÃ­tico experto especializado en la polÃ­tica mexicana. Tu tarea es analizar la siguiente transcripciÃ³n de la MaÃ±anera del Pueblo de MÃ©xico y generar un reporte estructurado profesional.\\n\\nREQUISITOS ESTRICTOS DEL FORMATO:\\n\\n1. ENCABEZADO:\\nREPORTE MAÃ‘ANERA DEL PUEBLO\\n\\n2. SECCIÃ“N PARTICIPARON:\\n- Identifica TODOS los participantes que hablan en la transcripciÃ³n\\n- Formato: Nombre Completo - Cargo completo con siglas entre parÃ©ntesis\\n- Ejemplo: Edgar Amador - Secretario de Hacienda y CrÃ©dito PÃºblico (SHCP)\\n- Un participante por lÃ­nea, sin viÃ±etas\\n- Deja lÃ­nea en blanco despuÃ©s de esta secciÃ³n\\n\\n3. SECCIÃ“N TEMAS:\\n- Agrupa la informaciÃ³n en temas coherentes\\n- Cada tema debe iniciar con: TEMA: [Nombre descriptivo del tema]\\n- Bajo cada tema, usa viÃ±etas (â€¢) para los puntos clave\\n- Cada viÃ±eta debe:\\n  * Ser una oraciÃ³n completa\\n  * Mencionar quiÃ©n dijo o hizo quÃ©\\n  * Incluir datos numÃ©ricos exactos cuando se mencionen\\n  * Ser objetiva y factual\\n- MantÃ©n el orden cronolÃ³gico de los temas tratados\\n- Deja lÃ­nea en blanco entre temas\\n\\n4. ESTILO:\\n- Lenguaje formal y objetivo\\n- Sin opiniones personales\\n- Sin resÃºmenes finales\\n- Sin introducciones\\n- Sin interpretaciones\\n- Solo hechos y declaraciones textuales\\n\\n5. DATOS NUMÃ‰RICOS:\\n- SIEMPRE incluye cifras exactas mencionadas\\n- Usa el formato original (billones, millones, mdp, %, PIB, etc.)\\n- No redondees nÃºmeros\\n\\nEJEMPLO DE FORMATO ESPERADO:\\n\\nREPORTE MAÃ‘ANERA DEL PUEBLO\\n\\nPARTICIPARON\\n\\nEdgar Amador - SecretarÃ­a de Hacienda y CrÃ©dito PÃºblico (SHCP)\\nBertha GÃ³mez - SubsecretarÃ­a de Egresos de HCP (SSE)\\nJorge Mendoza - Banco Nacional de Obras y Servicios (BANOBRAS)\\n\\nTEMA: Plan de InversiÃ³n en Infraestructura para el Desarrollo con Bienestar\\nâ€¢ Edgar Amador (SHCP), presentÃ³ el Plan de InversiÃ³n en Infraestructura para el Desarrollo con Bienestar 2026-2030.\\nâ€¢ ExplicÃ³ que el centro de la estrategia es la inversiÃ³n pÃºblica para lograr un desarrollo con bienestar: servicios bÃ¡sicos, vivienda y conectividad.\\nâ€¢ Expuso que el objetivo es realizar una inversiÃ³n histÃ³rica pÃºblica y mixta por 5.6 billones de pesos en 8 sectores estratÃ©gicos.\\n\\nTEMA: T-MEC\\nâ€¢ La Presidenta afirmÃ³ que el T-MEC se encuentra en un proceso de revisiÃ³n y no de renegociaciÃ³n.\\n\\n---\\n\\nFecha del video: {{ $json.published_at }}\\nTÃ­tulo: {{ $json.title }}\\nURL: {{ $json.video_url }}\\nPalabras transcritas: {{ $json.transcription_words }}\\nDuraciÃ³n: {{ Math.floor($json.transcription_duration / 60) }} minutos\\n\\nTRANSCRIPCIÃ“N COMPLETA:\\n{{ $json.transcription }}\\n\\n---\\n\\nIMPORTANTE: Genera el reporte siguiendo EXACTAMENTE el formato indicado. No agregues secciones adicionales. No hagas interpretaciones. Solo reporta lo que fue dicho.\"\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.1,\n    \"topK\": 20,\n    \"topP\": 0.9,\n    \"maxOutputTokens\": 8192\n  },\n  \"safetySettings\": [\n    {\"category\": \"HARM_CATEGORY_HARASSMENT\", \"threshold\": \"BLOCK_NONE\"},\n    {\"category\": \"HARM_CATEGORY_HATE_SPEECH\", \"threshold\": \"BLOCK_NONE\"},\n    {\"category\": \"HARM_CATEGORY_SEXUALLY_EXPLICIT\", \"threshold\": \"BLOCK_NONE\"},\n    {\"category\": \"HARM_CATEGORY_DANGEROUS_CONTENT\", \"threshold\": \"BLOCK_NONE\"}\n  ]\n}",
        "options": {}
      },
      "id": "gemini_summary",
      "name": "Gemini Generate Summary",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2600,
        180
      ],
      "notes": "ðŸ¤– Genera resumen estructurado con IA"
    },
    {
      "parameters": {
        "jsCode": "const geminiResponse = $input.first().json;\nconst videoData = $('Get YouTube Transcript').first().json;\n\nlet resumen = '';\nif (geminiResponse.candidates && geminiResponse.candidates[0]) {\n  resumen = geminiResponse.candidates[0].content.parts[0].text;\n  console.log(`\\nâœ… RESUMEN GENERADO:`);\n  console.log(`   Caracteres: ${resumen.length}`);\n} else {\n  console.error('âŒ Error al generar resumen');\n  resumen = 'Error al generar resumen con Gemini';\n}\n\nconst participantesMatch = resumen.match(/PARTICIPARON([\\s\\S]*?)(?=\\n\\nTEMA:|$)/i);\nconst participantes = participantesMatch ? participantesMatch[1].trim() : '';\n\nconst temasMatches = resumen.match(/TEMA: ([^\\n]+)/g);\nconst temas = temasMatches ? temasMatches.map(t => t.replace('TEMA: ', '').trim()).join(', ') : '';\n\nconst fecha = new Date(videoData.published_at);\nconst fechaFormateada = fecha.toLocaleDateString('es-MX', {\n  day: '2-digit',\n  month: '2-digit',\n  year: 'numeric'\n});\n\nconst fechaArchivo = fecha.toISOString().slice(0,10).replace(/-/g, '');\n\nif (participantes) {\n  const numParticipantes = participantes.split('\\n').filter(p => p.trim()).length;\n  console.log(`   Participantes: ${numParticipantes}`);\n}\nif (temasMatches) {\n  console.log(`   Temas: ${temasMatches.length}`);\n}\n\nreturn [{\n  json: {\n    video_id: videoData.video_id,\n    video_url: videoData.video_url,\n    titulo: videoData.title,\n    fecha_original: videoData.published_at,\n    fecha_reporte: fechaFormateada,\n    resumen_completo: resumen,\n    participantes: participantes,\n    temas: temas,\n    thumbnail: videoData.thumbnail,\n    duracion_segundos: videoData.transcription_duration,\n    duracion_minutos: Math.floor(videoData.transcription_duration / 60),\n    palabras_transcritas: videoData.transcription_words,\n    confianza_transcripcion: videoData.transcription_confidence,\n    transcripcion_completa: videoData.transcription,\n    modo_busqueda: videoData.modo_busqueda,\n    filename: `Reporte_Mananera_${fechaArchivo}.txt`,\n    generated_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "prepare_output",
      "name": "Prepare Final Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2800,
        180
      ]
    },
    {
      "parameters": {
        "operation": "upload",
        "folderId": {
          "__rl": true,
          "value": "={{ $env.GDRIVE_FOLDER_ID }}",
          "mode": "id"
        },
        "name": "={{ $json.filename }}",
        "options": {
          "fileContent": "={{ $json.resumen_completo }}"
        }
      },
      "id": "save_gdrive",
      "name": "Save to Google Drive",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        3000,
        100
      ],
      "notes": "ðŸ’¾ Guarda en Google Drive"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO mananeras (\n  fecha, titulo, video_url, video_id, resumen, participantes, temas,\n  transcripcion, thumbnail, duracion_segundos, duracion_minutos,\n  palabras_transcritas, confianza_transcripcion, modo_busqueda, created_at\n) VALUES (\n  '{{ $json.fecha_reporte }}',\n  '{{ $json.titulo.replace(/'/g, \"''\") }}',\n  '{{ $json.video_url }}',\n  '{{ $json.video_id }}',\n  '{{ $json.resumen_completo.replace(/'/g, \"''\") }}',\n  '{{ $json.participantes.replace(/'/g, \"''\") }}',\n  '{{ $json.temas.replace(/'/g, \"''\") }}',\n  '{{ $json.transcripcion_completa.replace(/'/g, \"''\") }}',\n  '{{ $json.thumbnail }}',\n  {{ $json.duracion_segundos }},\n  {{ $json.duracion_minutos }},\n  {{ $json.palabras_transcritas }},\n  {{ $json.confianza_transcripcion }},\n  '{{ $json.modo_busqueda }}',\n  NOW()\n)\nON CONFLICT (video_id) DO UPDATE SET\n  resumen = EXCLUDED.resumen,\n  transcripcion = EXCLUDED.transcripcion,\n  updated_at = NOW()\nRETURNING id, fecha, titulo;",
        "options": {}
      },
      "id": "save_supabase",
      "name": "Save to Supabase",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        3000,
        200
      ],
      "notes": "ðŸ’¾ Guarda en base de datos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{ $env.WHATSAPP_PHONE_ID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $env.WHATSAPP_ACCESS_TOKEN }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $env.WHATSAPP_RECIPIENT_NUMBER }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": true,\n    \"body\": \"ðŸ“‹ *REPORTE MAÃ‘ANERA DEL PUEBLO*\\n\\nðŸ“… Fecha: {{ $json.fecha_reporte }}\\nðŸŽ¥ {{ $json.titulo }}\\nâ±ï¸ DuraciÃ³n: {{ $json.duracion_minutos }} min\\nðŸ“ Palabras: {{ $json.palabras_transcritas }}\\nðŸ“Š Confianza: {{ Math.round($json.confianza_transcripcion * 100) }}%\\nðŸ” Modo: {{ $json.modo_busqueda }}\\n\\n{{ $json.resumen_completo.length > 1000 ? $json.resumen_completo.substring(0, 1000) + '...\\n\\nðŸ“„ [Resumen completo en Google Drive]' : $json.resumen_completo }}\\n\\nðŸ”— Video: {{ $json.video_url }}\\n\\nâœ… Guardado en Drive y DB\"\n  }\n}",
        "options": {}
      },
      "id": "send_whatsapp",
      "name": "Send WhatsApp Notification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3000,
        300
      ],
      "notes": "ðŸ“± EnvÃ­a notificaciÃ³n por WhatsApp"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "=âœ… REPORTE GENERADO EXITOSAMENTE\n\nðŸ“‹ INFORMACIÃ“N:\nModo: {{ $json.modo_busqueda }}\nFecha: {{ $json.fecha_reporte }}\nTÃ­tulo: {{ $json.titulo }}\nDuraciÃ³n: {{ $json.duracion_minutos }} minutos\nPalabras: {{ $json.palabras_transcritas }}\nConfianza: {{ Math.round($json.confianza_transcripcion * 100) }}%\n\nâœ… Guardado en Google Drive\nâœ… Registrado en Supabase\nâœ… NotificaciÃ³n WhatsApp enviada",
        "options": {}
      },
      "id": "success_response",
      "name": "Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        3200,
        180
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "=âŒ NO SE ENCONTRÃ“ VIDEO\n\nModo: {{ $json.debug_info?.modo || 'Unknown' }}\nFecha: {{ $json.debug_info?.fecha || 'Unknown' }}\nRango bÃºsqueda: {{ $json.debug_info?.search_start }} â†’ {{ $json.debug_info?.search_end }}\n\nError: {{ $json.message }}\n\nðŸ’¡ SUGERENCIAS:\n- Verifica que la fecha sea correcta\n- Para MANUAL: el video debe existir en esa fecha\n- Para AUTOMÃTICO: ejecutar despuÃ©s de las 9:00 AM MÃ©xico\n- Verifica que el video estÃ© publicado en el canal",
        "options": {
          "responseCode": 404
        }
      },
      "id": "error_no_video",
      "name": "Error - No Video Found",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1400,
        520
      ]
    },
    {
      "parameters": {
        "content": "## ðŸŽ¯ LÃ“GICA CORRECTA v3\n\n### MODO MANUAL (HistÃ³rico)\n- âœ… Busca en TODO EL DÃA (00:00-23:59 UTC)\n- âœ… Para encontrar videos ya publicados\n- âœ… Usar con \"Set Date Parameter\"\n\n### MODO AUTOMÃTICO (Schedule)\n- âœ… Se ejecuta a las 9:00 AM MÃ©xico (15:00 UTC)\n- âœ… Busca videos de 5:00-9:00 AM MÃ©xico\n- âœ… Espera a que termine la transmisiÃ³n\n- âœ… La maÃ±anera termina ~9:00 AM\n- âœ… El video ya debe estar publicado\n\n### DIFERENCIAS CLAVE:\n```\nMANUAL:\n  search_start: 2026-02-03T00:00:00Z\n  search_end:   2026-02-03T23:59:59Z\n\nAUTOMÃTICO:\n  search_start: 2026-02-03T11:00:00Z (5 AM MX)\n  search_end:   2026-02-03T15:00:00Z (9 AM MX)\n```",
        "height": 557.859204979968,
        "width": 425.6934673366835,
        "color": 3
      },
      "id": "sticky_logic",
      "name": "Sticky Note - LÃ“GICA",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        180,
        600
      ]
    },
    {
      "parameters": {
        "content": "## âš™ï¸ VARIABLES DE ENTORNO\n\n```bash\n# YouTube API\nYOUTUBE_API_KEY=AIzaSy...\n\n# AssemblyAI\nASSEMBLYAI_API_KEY=...\n\n# Google Gemini\nGEMINI_API_KEY=AIzaSy...\n\n# Google Drive\nGDRIVE_FOLDER_ID=1ABC...\n\n# WhatsApp\nWHATSAPP_PHONE_ID=123...\nWHATSAPP_ACCESS_TOKEN=EAA...\nWHATSAPP_RECIPIENT_NUMBER=521...\n```\n\n## ðŸ• HORARIOS\n\n**Schedule Trigger:**\n- Cron: `0 15 * * 1-5`\n- Hora: 15:00 UTC = 9:00 AM MÃ©xico\n- DÃ­as: Lunes a Viernes\n\n**MaÃ±anera:**\n- Inicia: ~7:00 AM MÃ©xico\n- Termina: ~9:00 AM MÃ©xico\n- Video publicado: ~9:00 AM MÃ©xico",
        "height": 557.859204979968,
        "width": 424.0134228187919,
        "color": 4
      },
      "id": "sticky_config",
      "name": "Sticky Note - CONFIG",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        660,
        600
      ]
    },
    {
      "parameters": {
        "jsCode": "// ================================================\n// OBTENER TRANSCRIPCIÃ“N DE YOUTUBE (Solo JavaScript)\n// ================================================\n\nconst videoData = $input.first().json;\nconst videoId = videoData.video_id;\n\nconsole.log(`\\nðŸ“ Obteniendo transcripciÃ³n del video: ${videoId}`);\nconsole.log(`   TÃ­tulo: ${videoData.title}`);\n\n// FunciÃ³n para obtener transcripciÃ³n usando la API interna de YouTube\nasync function getYouTubeTranscript(videoId) {\n  const https = require('https');\n  \n  return new Promise((resolve, reject) => {\n    // YouTube almacena los subtÃ­tulos en formato XML\n    // Primero necesitamos obtener la URL de los subtÃ­tulos\n    const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;\n    \n    https.get(videoUrl, (res) => {\n      let data = '';\n      \n      res.on('data', (chunk) => {\n        data += chunk;\n      });\n      \n      res.on('end', () => {\n        try {\n          // Buscar la URL de subtÃ­tulos en el HTML\n          const captionMatch = data.match(/\"captionTracks\":\\[{\"baseUrl\":\"([^\"]+)\"/);\n          \n          if (!captionMatch) {\n            reject(new Error('No se encontraron subtÃ­tulos para este video'));\n            return;\n          }\n          \n          let captionUrl = captionMatch[1].replace(/\\\\u0026/g, '&');\n          \n          // Obtener los subtÃ­tulos\n          https.get(captionUrl, (captionRes) => {\n            let captionData = '';\n            \n            captionRes.on('data', (chunk) => {\n              captionData += chunk;\n            });\n            \n            captionRes.on('end', () => {\n              resolve(captionData);\n            });\n          }).on('error', reject);\n          \n        } catch (error) {\n          reject(error);\n        }\n      });\n    }).on('error', reject);\n  });\n}\n\n// FunciÃ³n para parsear XML de subtÃ­tulos\nfunction parseTranscript(xmlData) {\n  const textRegex = /<text start=\"([^\"]+)\" dur=\"([^\"]+)\"[^>]*>([^<]+)<\\/text>/g;\n  let match;\n  let transcript = [];\n  let fullText = '';\n  \n  while ((match = textRegex.exec(xmlData)) !== null) {\n    const start = parseFloat(match[1]);\n    const duration = parseFloat(match[2]);\n    let text = match[3]\n      .replace(/&amp;/g, '&')\n      .replace(/&lt;/g, '<')\n      .replace(/&gt;/g, '>')\n      .replace(/&quot;/g, '\"')\n      .replace(/&#39;/g, \"'\")\n      .replace(/\\n/g, ' ')\n      .trim();\n    \n    const minutes = Math.floor(start / 60);\n    const seconds = Math.floor(start % 60);\n    const timestamp = `[${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}]`;\n    \n    transcript.push({\n      timestamp,\n      text,\n      start,\n      duration\n    });\n    \n    fullText += text + ' ';\n  }\n  \n  return {\n    entries: transcript,\n    fullText: fullText.trim()\n  };\n}\n\n// Ejecutar\ntry {\n  const xmlData = await getYouTubeTranscript(videoId);\n  const parsed = parseTranscript(xmlData);\n  \n  // Formatear transcripciÃ³n con timestamps\n  let formattedTranscription = '';\n  parsed.entries.forEach(entry => {\n    formattedTranscription += `${entry.timestamp} ${entry.text}\\n`;\n  });\n  \n  const transcription = `=== TRANSCRIPCIÃ“N MAÃ‘ANERA DEL PUEBLO ===\\n\\n${formattedTranscription}`;\n  \n  console.log(`âœ… TranscripciÃ³n obtenida exitosamente`);\n  console.log(`   Palabras: ${parsed.fullText.split(' ').length}`);\n  console.log(`   Entradas: ${parsed.entries.length}`);\n  \n  return [{\n    json: {\n      ...videoData,\n      transcription: transcription,\n      transcription_raw: parsed.fullText,\n      transcription_words: parsed.fullText.split(' ').length,\n      transcription_confidence: 0.92,\n      transcription_duration: parsed.entries[parsed.entries.length - 1]?.start || 0,\n      utterances_count: parsed.entries.length,\n      processing_completed: true,\n      transcription_method: 'YouTube Captions API'\n    }\n  }];\n  \n} catch (error) {\n  console.error(`âŒ Error: ${error.message}`);\n  \n  return [{\n    json: {\n      ...videoData,\n      error: true,\n      error_message: `Error al obtener transcripciÃ³n: ${error.message}`,\n      transcription: '',\n      transcription_raw: '',\n      transcription_words: 0\n    }\n  }];\n}\n"
      },
      "id": "get_youtube_transcript",
      "name": "Get YouTube Transcript",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1400,
        280
      ],
      "notes": "ðŸŽ¯ Obtiene transcripciÃ³n usando JavaScript puro (sin Python)"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// GENERAR REPORTE HTML A PARTIR DE LA PLANTILLA\n// Requiere variable de entorno: COVER_IMAGE_URL\n// (URL pÃºblica o base64 de la imagen de portada)\n// ============================================================\n\nconst d = $input.first().json;\n\n// â”€â”€ Parsear secciÃ³n PARTICIPARON â”€â”€\nfunction parseParticipantes(text) {\n  const m = text.match(/PARTICIPARON[\\s\\S]*?\\n([\\s\\S]*?)(?=\\n\\nTEMA:)/i);\n  if (!m) return [];\n  return m[1].split('\\n').map(l => l.trim()).filter(l => l.length > 2).map(l => {\n    const idx = l.indexOf(' - ');\n    return idx > -1 ? { nombre: l.slice(0, idx), cargo: l.slice(idx + 3) } : { nombre: l, cargo: '' };\n  });\n}\n\n// â”€â”€ Parsear secciones TEMA â”€â”€\nfunction parseTemas(text) {\n  const rx = /TEMA:\\s*([^\\n]+)\\n([\\s\\S]*?)(?=\\nTEMA:\\s|$)/gi;\n  const temas = []; let m;\n  while ((m = rx.exec(text)) !== null) {\n    const puntos = m[2].split('\\n').map(l => l.trim())\n      .filter(l => l.startsWith('\\u2022') || l.startsWith('-'))\n      .map(l => l.replace(/^[\\u2022\\-]\\s*/, ''));\n    temas.push({ titulo: m[1].trim(), puntos });\n  }\n  return temas;\n}\n\nconst participantes = parseParticipantes(d.resumen_completo || '');\nconst temas = parseTemas(d.resumen_completo || '');\nconst fechaObj = new Date(d.fecha_original || d.generated_at);\nconst dia = fechaObj.toLocaleDateString('es-MX', { day: '2-digit' });\nconst mesAnio = fechaObj.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });\nconst confianza = Math.round((d.confianza_transcripcion || 0) * 100);\nconst generadoEn = new Date(d.generated_at || new Date())\n  .toLocaleString('es-MX', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });\nconst coverUrl = $env.COVER_IMAGE_URL || '';\n\n// â”€â”€ HTML participantes â”€â”€\nconst participantesHtml = participantes.length > 0\n  ? participantes.map(p =>\n      '<div class=\"participante-item\"><div class=\"participante-bullet\"></div><div>' +\n      '<span class=\"participante-nombre\">' + p.nombre + '</span>' +\n      (p.cargo ? '<span class=\"participante-cargo\"> &ndash; ' + p.cargo + '</span>' : '') +\n      '</div></div>').join('')\n  : (d.participantes || '').split('\\n').filter(l => l.trim()).map(l =>\n      '<div class=\"participante-item\"><div class=\"participante-bullet\"></div><div>' + l.trim() + '</div></div>'\n    ).join('') || '<p style=\"color:#888\">Sin informaci&oacute;n de participantes.</p>';\n\n// â”€â”€ HTML temas â”€â”€\nconst temasHtml = temas.length > 0\n  ? temas.map((t, i) =>\n      '<div class=\"tema-bloque\">' +\n      '<div class=\"tema-titulo\"><span class=\"tema-titulo-num\">' + (i+1) + '</span>' + t.titulo + '</div>' +\n      '<div class=\"tema-contenido\">' +\n      t.puntos.map(p => '<div class=\"tema-punto\"><span class=\"tema-punto-bullet\">&bull;</span><span>' + p + '</span></div>').join('') +\n      '</div></div>').join('')\n  : '<div class=\"resumen-completo\">' + (d.resumen_completo || '').replace(/\\n/g, '<br>') + '</div>';\n\n// â”€â”€ CSS â”€â”€\nconst css = ':root{--verde:#006633;--verde-osc:#004422;--verde-claro:#e8f5e9;--dorado:#C8972B;--gris-claro:#f5f5f5;--gris-borde:#ddd}' +\n  '*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}' +\n  'body{font-family:\\'Segoe UI\\',Arial,sans-serif;font-size:14px;color:#444;background:#fff;line-height:1.6}' +\n  '.portada{width:100%;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;position:relative;page-break-after:always;overflow:hidden}' +\n  '.portada-bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center top;z-index:0}' +\n  '.portada::after{content:\\'\\';position:absolute;inset:0;background:linear-gradient(to bottom,transparent 40%,rgba(0,68,34,.85) 75%,rgba(0,68,34,.97) 100%);z-index:1}' +\n  '.portada-info{position:relative;z-index:2;width:100%;padding:48px 56px 56px;color:#fff}' +\n  '.portada-etiqueta{display:inline-block;background:var(--dorado);color:#fff;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:5px 14px;border-radius:3px;margin-bottom:18px}' +\n  '.portada-titulo{font-size:42px;font-weight:900;line-height:1.15;margin-bottom:12px;text-shadow:0 2px 8px rgba(0,0,0,.4)}' +\n  '.portada-subtitulo{font-size:16px;opacity:.9;max-width:680px;margin-bottom:32px}' +\n  '.portada-meta{display:flex;gap:32px;flex-wrap:wrap;align-items:center;border-top:1px solid rgba(255,255,255,.25);padding-top:24px}' +\n  '.portada-meta-item{display:flex;flex-direction:column;gap:2px}' +\n  '.portada-meta-label{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;opacity:.65}' +\n  '.portada-meta-valor{font-size:17px;font-weight:700}' +\n  '.portada-link a{color:var(--dorado);text-decoration:none;font-size:13px;font-weight:600;word-break:break-all}' +\n  '.portada-thumbnail{position:absolute;top:24px;right:40px;z-index:2;width:200px;border-radius:8px;border:3px solid rgba(255,255,255,.3);box-shadow:0 4px 20px rgba(0,0,0,.4);overflow:hidden}' +\n  '.portada-thumbnail img{width:100%;display:block}' +\n  '.portada-thumbnail-caption{background:rgba(0,0,0,.6);color:#fff;font-size:10px;text-align:center;padding:4px 6px}' +\n  '.reporte{max-width:900px;margin:0 auto;padding:48px 40px 80px}' +\n  '.reporte-header{display:flex;align-items:center;gap:16px;border-bottom:3px solid var(--verde);padding-bottom:18px;margin-bottom:36px}' +\n  '.reporte-header-logo{width:56px;height:56px;background:var(--verde);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:28px}' +\n  '.reporte-header-texto h1{font-size:22px;font-weight:900;color:var(--verde-osc)}' +\n  '.reporte-header-texto p{font-size:13px;color:#777;margin-top:2px}' +\n  '.reporte-header-fecha{margin-left:auto;text-align:right}' +\n  '.fecha-dia{font-size:40px;font-weight:900;color:var(--verde);line-height:1}' +\n  '.fecha-resto{font-size:13px;color:#777;text-transform:uppercase;letter-spacing:1px}' +\n  '.seccion-participaron{background:var(--verde-claro);border-left:5px solid var(--verde);border-radius:0 8px 8px 0;padding:20px 24px;margin-bottom:40px}' +\n  '.seccion-participaron h2{font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--verde-osc);margin-bottom:14px;display:flex;align-items:center;gap:8px}' +\n  '.seccion-participaron h2::before{content:\\'\\';display:inline-block;width:8px;height:8px;background:var(--verde);border-radius:50%}' +\n  '.participante-item{display:flex;align-items:baseline;gap:8px;padding:6px 0;border-bottom:1px solid rgba(0,102,51,.12)}' +\n  '.participante-item:last-child{border-bottom:none}' +\n  '.participante-bullet{width:6px;height:6px;background:var(--dorado);border-radius:50%;flex-shrink:0;margin-top:5px}' +\n  '.participante-nombre{font-weight:600;color:var(--verde-osc)}' +\n  '.participante-cargo{color:#666;font-size:13px}' +\n  '.tema-bloque{margin-bottom:36px}' +\n  '.tema-titulo{font-size:16px;font-weight:700;color:#fff;background:var(--verde);padding:10px 20px;border-radius:6px 6px 0 0;display:flex;align-items:center;gap:10px}' +\n  '.tema-titulo-num{background:var(--dorado);color:#fff;font-size:11px;font-weight:900;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}' +\n  '.tema-contenido{background:var(--gris-claro);border:1px solid var(--gris-borde);border-top:none;border-radius:0 0 6px 6px;padding:16px 20px}' +\n  '.tema-punto{display:flex;align-items:flex-start;gap:10px;padding:7px 0;border-bottom:1px dashed var(--gris-borde);line-height:1.55}' +\n  '.tema-punto:last-child{border-bottom:none}' +\n  '.tema-punto-bullet{color:var(--verde);font-size:18px;line-height:1.2;flex-shrink:0}' +\n  '.resumen-completo{white-space:pre-wrap;font-size:13.5px;line-height:1.7}' +\n  '.reporte-footer{margin-top:60px;border-top:2px solid var(--verde-claro);padding-top:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;font-size:11px;color:#999}' +\n  '.reporte-footer a{color:var(--verde);text-decoration:none}' +\n  '.reporte-footer-badge{background:var(--verde-claro);padding:6px 12px;border-radius:20px;color:var(--verde-osc);font-weight:600;font-size:11px}' +\n  '.reporte-footer-stats{display:flex;gap:20px;flex-wrap:wrap}' +\n  '.stat-item{display:flex;flex-direction:column;align-items:center}' +\n  '.stat-valor{font-weight:700;font-size:16px;color:var(--verde-osc)}' +\n  '.stat-label{font-size:10px;letter-spacing:1px;text-transform:uppercase;color:#999}' +\n  '@media print{.portada{page-break-after:always;min-height:100vh}.portada-thumbnail{display:none}.reporte{padding:32px}}';\n\nconst thumbHtml = d.thumbnail\n  ? '<div class=\"portada-thumbnail\"><img src=\"' + d.thumbnail + '\" alt=\"Miniatura\"><div class=\"portada-thumbnail-caption\">&#9654; Ver en YouTube</div></div>'\n  : '';\n\n// â”€â”€ ConstrucciÃ³n del HTML final â”€â”€\nconst html = '<!DOCTYPE html>\\n' +\n  '<html lang=\"es\">\\n<head>\\n' +\n  '<meta charset=\"UTF-8\">\\n' +\n  '<meta name=\"viewport\" content=\"width=device-width,initial-scale=1.0\">\\n' +\n  '<title>Ma&ntilde;anera del Pueblo &ndash; ' + (d.fecha_reporte||'') + '</title>\\n' +\n  '<style>' + css + '</style>\\n</head>\\n<body>\\n\\n' +\n  '<div class=\"portada\">\\n' +\n  '  <img class=\"portada-bg\" src=\"' + coverUrl + '\" alt=\"Portada\" onerror=\"this.style.display='none'\">\\n' +\n  '  ' + thumbHtml + '\\n' +\n  '  <div class=\"portada-info\">\\n' +\n  '    <div class=\"portada-etiqueta\">Reporte Oficial</div>\\n' +\n  '    <h1 class=\"portada-titulo\">Ma&ntilde;anera del Pueblo</h1>\\n' +\n  '    <p class=\"portada-subtitulo\">' + (d.titulo||'') + '</p>\\n' +\n  '    <div class=\"portada-meta\">\\n' +\n  '      <div class=\"portada-meta-item\"><span class=\"portada-meta-label\">Fecha</span><span class=\"portada-meta-valor\">' + (d.fecha_reporte||'') + '</span></div>\\n' +\n  '      <div class=\"portada-meta-item\"><span class=\"portada-meta-label\">Duraci&oacute;n</span><span class=\"portada-meta-valor\">' + (d.duracion_minutos||0) + ' min</span></div>\\n' +\n  '      <div class=\"portada-meta-item\"><span class=\"portada-meta-label\">Palabras</span><span class=\"portada-meta-valor\">' + (d.palabras_transcritas||0).toLocaleString('es-MX') + '</span></div>\\n' +\n  '      <div class=\"portada-meta-item portada-link\"><span class=\"portada-meta-label\">Video</span><a href=\"' + (d.video_url||'#') + '\">' + (d.video_url||'') + '</a></div>\\n' +\n  '    </div>\\n  </div>\\n</div>\\n\\n' +\n  '<div class=\"reporte\">\\n' +\n  '  <div class=\"reporte-header\">\\n' +\n  '    <div class=\"reporte-header-logo\">&#x1F985;</div>\\n' +\n  '    <div class=\"reporte-header-texto\"><h1>Ma&ntilde;anera del Pueblo</h1><p>Gobierno de M&eacute;xico &middot; Conferencia de prensa matutina</p></div>\\n' +\n  '    <div class=\"reporte-header-fecha\"><div class=\"fecha-dia\">' + dia + '</div><div class=\"fecha-resto\">' + mesAnio + '</div></div>\\n' +\n  '  </div>\\n\\n' +\n  '  <div class=\"seccion-participaron\"><h2>Participaron</h2>' + participantesHtml + '</div>\\n\\n' +\n  '  ' + temasHtml + '\\n\\n' +\n  '  <div class=\"reporte-footer\">\\n' +\n  '    <div class=\"reporte-footer-stats\">\\n' +\n  '      <div class=\"stat-item\"><span class=\"stat-valor\">' + (d.duracion_minutos||0) + '</span><span class=\"stat-label\">Minutos</span></div>\\n' +\n  '      <div class=\"stat-item\"><span class=\"stat-valor\">' + (d.palabras_transcritas||0).toLocaleString('es-MX') + '</span><span class=\"stat-label\">Palabras</span></div>\\n' +\n  '      <div class=\"stat-item\"><span class=\"stat-valor\">' + confianza + '%</span><span class=\"stat-label\">Confianza IA</span></div>\\n' +\n  '    </div>\\n' +\n  '    <div class=\"reporte-footer-badge\">&#x1F916; Generado con IA &middot; ' + generadoEn + '</div>\\n' +\n  '    <div><a href=\"' + (d.video_url||'#') + '\" target=\"_blank\">&#x1F4FA; Ver video completo</a></div>\\n' +\n  '  </div>\\n</div>\\n\\n</body>\\n</html>';\n\nconst fechaArchivo = (d.fecha_original||new Date().toISOString()).slice(0,10).replace(/-/g,'');\nconsole.log('HTML generado: ' + html.length + ' chars | temas: ' + temas.length + ' | participantes: ' + participantes.length);\n\nreturn [{ json: { ...d, html_reporte: html, filename_html: 'Reporte_Mananera_' + fechaArchivo + '.html' } }];"
      },
      "id": "generate_html_report",
      "name": "Generate HTML Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3000,
        420
      ],
      "notes": "Genera reporte HTML. Configurar COVER_IMAGE_URL en variables de entorno con la URL de la imagen de portada."
    },
    {
      "parameters": {
        "operation": "upload",
        "folderId": {
          "__rl": true,
          "value": "={{ $env.GDRIVE_FOLDER_ID }}",
          "mode": "id"
        },
        "name": "={{ $json.filename_html }}",
        "options": {
          "fileContent": "={{ $json.html_reporte }}"
        }
      },
      "id": "save_html_drive",
      "name": "Save HTML to Google Drive",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        3200,
        420
      ],
      "notes": "Guarda el reporte HTML en Google Drive"
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Merge Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Set Date Parameter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Date Parameter": {
      "main": [
        [
          {
            "node": "Merge Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Configuration": {
      "main": [
        [
          {
            "node": "Get YouTube Videos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get YouTube Videos": {
      "main": [
        [
          {
            "node": "Filter MaÃ±anera Video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter MaÃ±anera Video": {
      "main": [
        [
          {
            "node": "Check Video Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Video Exists": {
      "main": [
        [
          {
            "node": "Get YouTube Transcript",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error - No Video Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Start AssemblyAI Transcription": {
      "main": [
        [
          {
            "node": "Save Transcript ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Transcript ID": {
      "main": [
        [
          {
            "node": "Wait 10s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 10s": {
      "main": [
        [
          {
            "node": "Check Transcription Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Transcription Status": {
      "main": [
        [
          {
            "node": "Is Completed?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Completed?": {
      "main": [
        [
          {
            "node": "Process Transcription",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Increment Retry Counter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Retry Counter": {
      "main": [
        [
          {
            "node": "Wait 30s",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error - Timeout",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 30s": {
      "main": [
        [
          {
            "node": "Check Transcription Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Transcription": {
      "main": [
        [
          {
            "node": "Gemini Generate Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Generate Summary": {
      "main": [
        [
          {
            "node": "Prepare Final Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Final Output": {
      "main": [
        [
          {
            "node": "Save to Google Drive",
            "type": "main",
            "index": 0
          },
          {
            "node": "Save to Supabase",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send WhatsApp Notification",
            "type": "main",
            "index": 0
          },
          {
            "node": "Generate HTML Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Google Drive": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Supabase": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send WhatsApp Notification": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get YouTube Transcript": {
      "main": [
        [
          {
            "node": "Gemini Generate Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML Report": {
      "main": [
        [
          {
            "node": "Save HTML to Google Drive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save HTML to Google Drive": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "5.0-javascript-only",
  "id": "mananera_v3_final",
  "tags": [
    {
      "id": "1",
      "name": "producciÃ³n"
    },
    {
      "id": "2",
      "name": "v3-final"
    }
  ]
}